---
layout: post
title: ARM中的ARM/Thumb指令的内存对齐问题
---

前段时间我需要写程序以分析汇编代码,但是在ldr寻址这里卡住了
{% highlight bash %}
ldr r1,[pc,#0x1c]
{% endhighlight %}
比如上面这行代码,是以pc寄存器为基础,再加上0x1c,pc寄存器按理说就是下条指令的地址,Thumb的指令为2字节或者4字节,ARM均为4字节,所以,现在是Thumb模式,那么PC寄存器应该每次+2,开始前几个ldr指令都可以正确算出目标地址,然后后面的ldr我发现好几个都多了2字节,找回去发现问题出在pc上,这里的pc是+4的......

然后我各自都试过,以为和Thumb的2/4字节有关..等等,最后仍然不确定.网上查也没结果.我只是需要一个规律,之后我就可以用代码去判断了.

最后在一次尝试中,我看到了地址,那个时候就猜测是否为4的倍数,试了下,确实这样..

无论arm/thumb模式,当指令地址为4的倍数的时候,pc是正常的,为该指令地址+0x4
但当在thumb模式时,有时候指令地址会为2的倍数但非4的倍数,这个时候pc是该指令地址+0x2

简单说,PC寄存器永远为4的倍数,判断也就简单了,为4的倍数,那就+4,反之,+2.
